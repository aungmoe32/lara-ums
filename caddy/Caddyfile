{
    # Global Option: On-Demand TLS for Custom Domains
    on_demand_tls {
        # Caddy asks this URL before issuing a cert
        ask http://nginx:80/caddy-check
        
        # Rate limits to prevent attacks
        interval 2m
        burst 5
    }
}

# Block A: Root + Wildcard
bartarpyan.site, *.bartarpyan.site {
    # Use the static file from Cloudflare (valid for 15 years)
    tls /data/certs/cert.pem /data/certs/key.pem

    reverse_proxy nginx:80
}

# Block B: Custom Domains (MUST be Grey Cloud / DNS Only in Cloudflare)
:443 {
    tls {
        on_demand
    }
    reverse_proxy nginx:80
}

:80 {
    # Redirect HTTP to HTTPS automatically
    redir https://{host}{uri} permanent
}